#+TITLE: EWM Compositor Tasks
#+STARTUP: overview

This document tracks complexity areas and remaining work in the compositor.

* VBlank State Machine
:PROPERTIES:
:STATUS: needs-decision
:END:

*Current state:* =RedrawState= enum has 5 states to handle VBlank synchronization and estimated VBlank timers for damage-less frames.

*Files:* =src/backend/drm.rs=

*Question:* Are estimated VBlank timers necessary?
- Current: Uses timers when no damage to maintain frame callbacks without real flip
- Alternative: Always queue real frame (wastes power but simpler)
- Alternative: Accept that frame callbacks pause when idle (may affect some clients)

*Decision:*

*Simplification potential:* Reduce to 3 states (Idle, Queued, WaitingForVBlank), remove timer logic

* Multi-View Surface Rendering
:PROPERTIES:
:STATUS: needs-decision
:END:

*Current state:* =surface_views: HashMap<u32, Vec<SurfaceView>>= allows rendering the same Wayland surface at multiple positions simultaneously. Used for showing the same buffer in multiple Emacs windows.

*Files:* =src/main.rs=, =src/render.rs=

*Question:* Could Emacs handle this differently?
- Current: Compositor clones surface at multiple positions
- Alternative: Emacs creates separate Wayland surfaces per view
- Alternative: Only show surface in "active" view, hide in others

*Decision:*

*Simplification potential:* Remove secondary view rendering code, simpler layout commands

* Emacs Reconnection
:PROPERTIES:
:STATUS: needs-decision
:END:

*Current state:* IPC handling tracks connection state to clean up old event sources when Emacs reconnects.

*Files:* =src/ipc.rs=

*Question:* Can you assume the compositor restarts if Emacs disconnects?

*Decision:*

*Simplification potential:* Remove token tracking, simplify connection handling

* Mouse/Pointer Support (DRM Backend)

*Current state:* Basic mouse input and cursor rendering implemented. Missing advanced features compared to niri.

*Files:* =src/backend/drm.rs=, =src/cursor.rs=, =src/render.rs=, =src/main.rs=

** DONE Pointer motion (relative + absolute)
** DONE Pointer button events
** DONE Scroll wheel events
** DONE Fallback cursor rendering
** DONE Relative motion events
** DONE Correct scroll speed (15px per click)

** TODO [#B] Client Cursor Support
Apps can't set their own cursor (resize handles, text cursor, etc.). The =cursor_image()= callback in =SeatHandler= is empty.

*Fix:* Store =CursorImageStatus= in state, render client surface when =Surface= variant, fallback when =Named=.

** TODO [#B] Pointer Constraints
Games that lock/confine pointer won't work. Need to implement =zwp_pointer_constraints= protocol.

*Fix:* Add =delegate_pointer_constraints!=, check constraints before updating position, send only relative motion when locked.

** TODO [#C] XCursor Theme Loading
Currently using embedded fallback cursor only. Should load system themes.

*Fix:* Add =xcursor= crate, implement theme loading like niri's =CursorManager=.

** TODO [#C] Scroll Improvements
Missing: =relative_direction=, =v120= passthrough.
DONE: finger =stop= events (required for touchpad scrolling in Firefox).

** TODO [#C] Interactive Move/Resize
Mod+click to move/resize windows (niri feature).

* DONE Backend Support
:PROPERTIES:
:STATUS: keep
:END:

*Current state:* Winit (388 lines) and DRM (1563 lines) backends share IPC, input, and render logic via main.rs, input.rs, render.rs.

*Decision (2026-02-08):* Keep both. Winit essential for development (no logout), DRM essential for production. Size difference is inherent DRM complexity (VBlank, multi-output, hotplug, libinput), not duplication.

* DONE Multi-Output Support
:PROPERTIES:
:STATUS: done
:END:

*Implemented:* Full multi-monitor support including:
- All outputs rendered with proper coordinate offsets
- Output events (OutputDetected, OutputDisconnected) to Emacs
- ConfigureOutput and AssignOutput IPC commands
- One Emacs frame per output
- Hotplug support for runtime connect/disconnect

*Files:* =src/backend/drm.rs=, =ewm.el=

See =docs/MULTI_MONITOR_PLAN.md= for details.

* DONE Prefix Key Parsing
:PROPERTIES:
:STATUS: done
:END:

*Current state:* Emacs sends pre-parsed keysyms/modifiers. Renamed to "intercept-keys" for clarity.

*Files:* =src/main.rs=, =ewm.el=

*Decision:* Implemented the alternative approach. Emacs now sends:
={"cmd": "intercept-keys", "keys": [{"keysym": 120, "ctrl": true}, ...]}=

*Result:* Removed ~100 lines of parsing code. Added =ewm-input-global-keys= for EXWM-like super key bindings.

* DONE Focus Model
:PROPERTIES:
:STATUS: keep
:END:

*Current state:* Two fields track keyboard focus:
- =focused_surface_id: u32= - Logical focus (intent, survives VT switch)
- =keyboard_focus: Option<WlSurface>= - Actual focus (Wayland reality)

*Why both:* They diverge during VT switchâ€”actual focus is cleared but logical focus preserved for restore. Also needed: IPC uses IDs, Smithay API uses WlSurface.

* Session Log

** 2026-02-08
- Added multi-frame support for multiple outputs
- Added monitor hotplug support
- Fixed mouse-follows-focus on compositor-initiated focus
- Added mouse-follows-focus support
- Bidirectional focus sync between compositor and Emacs
- Apps now spawn on focused surface's output
- Track Emacs surfaces for correct multi-frame key handling
- Added runtime output mode configuration

** 2026-02-07
- Added prepare-frame command and outputs-complete event
- Added assign-output and configure-output commands
- Fixed pointer boundary calculation for y-offset
- Send output events to Emacs on connect
- Added multi-monitor rendering support
- Implemented mouse support for DRM backend (based on niri)
- Added fallback cursor rendering
- Fixed scroll speed to match niri (15px per v120 click)
- Added relative motion events
- Documented remaining pointer tasks
